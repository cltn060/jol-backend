<!-- django_analytics/partials/view_detail.html -->
<div class="space-y-6">
  
  <!-- Info Banner -->
  <div class="bg-slate-900 border border-slate-700 rounded-xl p-6">
    <div class="flex-1 space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-mono text-green-400 uppercase tracking-wider">// View Analysis: {{ view_name }}</h3>
        <div class="flex items-center gap-2">
          <div class="h-2 w-2 bg-blue-400 animate-pulse rounded-full"></div>
          <span class="text-[10px] font-mono text-blue-400 uppercase tracking-widest">Detailed Metrics</span>
        </div>
      </div>
      <p class="text-xs font-mono text-gray-300 leading-relaxed">
        <span class="text-cyan-400">&gt;</span> Isolated performance metrics and request logs for this specific endpoint.<br>
        <span class="text-cyan-400">&gt;</span> Analyze temporal patterns, error trends, and response characteristics.<br>
        <span class="text-cyan-400">&gt;</span> Full request history with expandable details including headers, body, and tracebacks.
      </p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white px-5 py-4 rounded-xl border border-gray-200 hover:border-gray-300 transition-colors">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Calls</div>
        <i class="fas fa-chart-bar text-blue-500 text-sm"></i>
      </div>
      <div class="text-3xl font-semibold text-gray-900">{{ view_stats.total_calls }}</div>
    </div>
    <div class="bg-white px-5 py-4 rounded-xl border border-gray-200 hover:border-gray-300 transition-colors">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Error Rate</div>
        <i class="fas fa-exclamation-circle text-red-500 text-sm"></i>
      </div>
      <div class="text-3xl font-semibold text-red-600">{{ view_stats.error_rate }}%</div>
    </div>
    <div class="bg-white px-5 py-4 rounded-xl border border-gray-200 hover:border-gray-300 transition-colors">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Avg Duration</div>
        <i class="fas fa-tachometer-alt text-blue-500 text-sm"></i>
      </div>
      <div class="text-3xl font-semibold text-blue-600">{{ view_stats.avg_duration }}<span class="text-lg text-gray-500 ml-1">ms</span></div>
    </div>
  </div>

  <div class="bg-white p-5 rounded-xl border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-semibold text-gray-900">Requests Over Time</h3>
                <!-- TIME RANGE FILTER -->
                <select name="range"
          class="text-xs border border-gray-300 rounded-lg px-3 py-1.5 bg-white text-gray-700 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          hx-get="{{ content_url }}?tab=views&view={{ view_name }}{% if current_status_filter %}&status={{ current_status_filter }}{% endif %}"
          hx-target="#tab-content"
          hx-include="[name='range'], #status-filter, [name='page']"
          hx-trigger="change from:body"
          hx-push-url="true">
    <option value="hour" {% if current_range == 'hour' %}selected{% endif %}>Last Hour</option>
    <option value="today" {% if not current_range or current_range == 'today' %}selected{% endif %}>Today</option>
    <option value="week" {% if current_range == 'week' %}selected{% endif %}>This Week</option>
  </select>
                </div>
    <canvas id="view-requests-chart" style="max-height:220px;"></canvas>
  </div>

<script>
  function rebuildChart(canvasId, labels, datasets) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    if (canvas.chart) canvas.chart.destroy();
    canvas.chart = new Chart(canvas, {
      type: 'bar',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { position: 'bottom' } },
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
      }
    });
  }

  // Rebuild after HTMX swap
  document.addEventListener('htmx:afterSwap', function(e) {
    if (e.detail.target.id !== 'tab-content') return;
    const labels = {{ chart_labels|safe }};
    const datasets = [
      { label: '2xx Success', data: {{ success_series|safe }}, backgroundColor: 'rgba(34,197,94,0.6)', borderColor: 'rgba(34,197,94,1)', borderWidth: 0, stack: 'Stack 0' },
      { label: '3xx Redirect', data: {{ redirect_series|safe }}, backgroundColor: 'rgba(59,130,246,0.6)', borderColor: 'rgba(59,130,246,1)', borderWidth: 0, stack: 'Stack 0' },
      { label: '4xx Client Error', data: {{ client_series|safe }}, backgroundColor: 'rgba(251,146,60,0.6)', borderColor: 'rgba(251,146,60,1)', borderWidth: 0, stack: 'Stack 0' },
      { label: '5xx Server Error', data: {{ error_series|safe }}, backgroundColor: 'rgba(239,68,68,0.6)', borderColor: 'rgba(239,68,68,1)', borderWidth: 0, stack: 'Stack 0' }
    ];
    rebuildChart('view-requests-chart', labels, datasets);
  });

  // Initial build
  rebuildChart('view-requests-chart', {{ chart_labels|safe }}, [
    { label: '2xx Success', data: {{ success_series|safe }}, backgroundColor: 'rgba(34,197,94,0.6)', borderColor: 'rgba(34,197,94,1)', borderWidth: 0, stack: 'Stack 0' },
    { label: '3xx Redirect', data: {{ redirect_series|safe }}, backgroundColor: 'rgba(59,130,246,0.6)', borderColor: 'rgba(59,130,246,1)', borderWidth: 0, stack: 'Stack 0' },
    { label: '4xx Client Error', data: {{ client_series|safe }}, backgroundColor: 'rgba(251,146,60,0.6)', borderColor: 'rgba(251,146,60,1)', borderWidth: 0, stack: 'Stack 0' },
    { label: '5xx Server Error', data: {{ error_series|safe }}, backgroundColor: 'rgba(239,68,68,0.6)', borderColor: 'rgba(239,68,68,1)', borderWidth: 0, stack: 'Stack 0' }
  ]);
</script>

  <!-- RECENT REQUESTS + FILTER -->
  <div class="bg-white rounded-xl border border-gray-200">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between px-5 py-4 border-b border-gray-200 gap-3">
      <h3 class="text-sm font-semibold text-gray-900">Recent Requests</h3>

      <!-- FILTER -->
      <select id="status-filter"
                name="status"
                class="text-xs border border-gray-300 rounded-lg px-3 py-1.5 bg-white text-gray-700 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                hx-get="{{ content_url }}?tab=views&view={{ view_name }}"
                hx-target="#tab-content"
                hx-include="#status-filter, [name='page']"
                hx-trigger="change from:body"
                hx-push-url="true">
          <option value="" {% if not current_status_filter %}selected{% endif %}>All Statuses</option>
          <option value="2xx" {% if current_status_filter == "2xx" %}selected{% endif %}>2xx Success</option>
          <option value="3xx" {% if current_status_filter == "3xx" %}selected{% endif %}>3xx Redirect</option>
          <option value="4xx" {% if current_status_filter == "4xx" %}selected{% endif %}>4xx Client Error</option>
          <option value="5xx" {% if current_status_filter == "5xx" %}selected{% endif %}>5xx Server Error</option>
        </select>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Request</th>
            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Method</th>
            <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Duration</th>
            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Timestamp</th>
          </tr>
        </thead>
        <tbody>
          {% for log in recent %}
          <tr class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors"
              data-request-id="{{ log.request_id }}"
              aria-controls="detail-{{ log.request_id }}"
              aria-expanded="false">
            <td class="px-5 py-3">
              <div class="flex items-center gap-2">
                <i class="fas fa-chevron-right caret-icon text-xs text-gray-400"></i>
                <span class="font-mono text-xs text-gray-900">{{ log.path|truncatechars:50 }}</span>
              </div>
            </td>
            <td class="px-5 py-3">
              <span class="{% if log.method == 'GET' %}bg-blue-500{% elif log.method == 'POST' %}bg-green-500{% elif log.method == 'PUT' %}bg-orange-500{% elif log.method == 'PATCH' %}bg-yellow-500{% elif log.method == 'DELETE' %}bg-red-500{% else %}bg-gray-500{% endif %} text-white px-2 py-1 rounded text-[10px] font-bold uppercase">{{ log.method }}</span>
            </td>
            <td class="px-5 py-3 text-center">
              <span class="{% if log.status_code >= 500 %}bg-red-100 text-red-700{% elif log.status_code >= 400 %}bg-orange-100 text-orange-700{% elif log.status_code >= 300 %}bg-blue-100 text-blue-700{% else %}bg-green-100 text-green-700{% endif %} px-2.5 py-1 rounded-full text-xs font-semibold">
                {{ log.status_code }}
              </span>
            </td>
            <td class="px-5 py-3 text-right">
              <span class="font-mono text-xs {% if log.duration_ms > 1000 %}text-red-600 font-semibold{% elif log.duration_ms > 500 %}text-orange-600{% else %}text-gray-600{% endif %}">
                {{ log.duration_ms }}ms
              </span>
            </td>
            <td class="px-5 py-3"><span class="text-xs text-gray-500 font-mono">{{ log.timestamp|date:"M d, H:i:s" }}</span></td>
          </tr>
          <tr id="detail-{{ log.request_id }}" class="detail-row bg-slate-900 border-b border-slate-700" style="display:none;">
            <td colspan="5" class="px-6 py-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div class="space-y-2">
                                    <div class="flex items-start gap-2">
                                        <span class="text-gray-400 font-medium min-w-[80px] font-mono text-xs uppercase tracking-wider">Path:</span>
                                        <span class="font-mono text-gray-100 break-all text-xs">{{ log.path }}</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-gray-400 font-medium min-w-[80px] font-mono text-xs uppercase tracking-wider">View:</span>
                                        <span class="text-gray-100 text-xs">{{ log.view_name|default:"couldn't resolve" }}</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-gray-400 font-medium min-w-[80px] font-mono text-xs uppercase tracking-wider">User:</span>
                                        <span class="text-gray-100 text-xs">{{ log.user|default:"-" }}</span>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-start gap-2">
                                        <span class="text-gray-400 font-medium min-w-[80px] font-mono text-xs uppercase tracking-wider">IP:</span>
                                        <span class="text-cyan-400 font-mono text-xs">{{ log.ip|default:"-" }}</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-gray-400 font-medium min-w-[80px] font-mono text-xs uppercase tracking-wider">Request ID:</span>
                                        <span class="font-mono text-emerald-400 text-xs">{{ log.request_id }}</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-gray-400 font-medium min-w-[80px] font-mono text-xs uppercase tracking-wider">User-Agent:</span>
                                        <span class="text-purple-400 break-words text-[10px] font-mono">{{ log.user_agent|default:"-" }}</span>
                                    </div>
                                </div>
                            </div>
                            {% if log.exception_message or log.traceback %}
                            <div class="mt-4 pt-4 border-t border-slate-700">
                                <h4 class="font-semibold text-red-400 mb-3 text-xs uppercase tracking-wider font-mono">Error Details</h4>
                                {% if log.exception_message %}
                                <div class="mb-3">
                                    <div class="text-[10px] font-mono text-gray-400 mb-1 uppercase tracking-wider">Exception:</div>
                                    <div class="font-mono text-xs text-red-300 bg-slate-800 px-3 py-2 border border-red-900/50">{{ log.exception_message }}</div>
                                </div>
                                {% endif %}
                                {% if log.traceback %}
                                <div>
                                    <div class="text-[10px] font-mono text-gray-400 mb-1 uppercase tracking-wider">Traceback:</div>
                                    <pre class="whitespace-pre-wrap p-3 bg-slate-800 border border-red-900/50 text-[10px] text-red-300 font-mono overflow-auto">{{ log.traceback }}</pre>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            <div class="mt-4 pt-4 border-t border-slate-700">
                                <div class="text-[10px] font-mono text-gray-400 mb-1 uppercase tracking-wider">Request Body:</div>
                                <pre class="whitespace-pre-wrap p-3 bg-slate-800 border border-slate-700 text-xs text-green-400 font-mono overflow-auto">{{ log.body|default_if_none:"No Request Body (Probably a GET request)" }}</pre>
                            </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-center py-12 text-sm text-gray-500">No requests match the filter</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- PAGINATION -->
    {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="px-5 py-4 border-t border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="text-xs text-gray-500 font-medium">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</div>
      <div class="flex flex-wrap justify-center sm:justify-end gap-1">
        {% if page_obj.has_previous %}
        <a hx-get="{{ content_url }}?tab=views&view={{ view_name }}{% if current_status_filter %}&status={{ current_status_filter }}{% endif %}&page={{ page_obj.previous_page_number }}"
           hx-target="#tab-content"
           class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-xs font-medium transition-colors">Previous</a>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
            <span class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-semibold">{{ num }}</span>
          {% else %}
            <a hx-get="{{ content_url }}?tab=views&view={{ view_name }}{% if current_status_filter %}&status={{ current_status_filter }}{% endif %}&page={{ num }}"
               hx-target="#tab-content"
               class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-xs font-medium transition-colors">{{ num }}</a>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <a hx-get="{{ content_url }}?tab=views&view={{ view_name }}{% if current_status_filter %}&status={{ current_status_filter }}{% endif %}&page={{ page_obj.next_page_number }}"
           hx-target="#tab-content"
           class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-xs font-medium transition-colors">Next</a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>